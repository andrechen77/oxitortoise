<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Wasm Debugger</title>
</head>

<body>
	<input type="text" id="model_name" placeholder="Model Name">
	<button id="load">Load</button>
	<button id="run_main">
		<pre>main()</pre>
	</button>

	<script>
		async function instantiateMain(modelName) {
			let wasmResult = null;
			let importObject = {
				env: {
					"write_to_console": (message, length) => {
						let mem = wasmResult.instance.exports.memory.buffer;
						let str = new TextDecoder().decode(new Uint8Array(mem, message, length));
						console.log(str);
					},
					"write_to_file": (namePtr, nameLength, bytesPtr, bytesLength) => {
						let mainMemory = wasmResult.instance.exports.memory;
						let bytes = new Uint8Array(mainMemory.buffer, bytesPtr, bytesLength);
						let name = new TextDecoder().decode(new Uint8Array(mainMemory.buffer, namePtr, nameLength));
						let blob = new Blob([bytes], { type: "application/octet-stream" });
						let url = URL.createObjectURL(blob);
						let a = document.createElement('a');
						a.href = url;
						a.download = name;
						document.body.appendChild(a);
						a.click();
						document.body.removeChild(a);
						URL.revokeObjectURL(url);
					},
					"instantiate_module": (auxModuleBufStart, auxModuleBufLen) => {
						try {
							console.log("instantiating module", auxModuleBufStart, auxModuleBufLen);

							let mainMemory = wasmResult.instance.exports["memory"];
							let auxModuleBuffer = new Uint8Array(mainMemory.buffer, auxModuleBufStart, auxModuleBufLen);

							// instantiate the auxiliary module
							let auxModule = new WebAssembly.Module(auxModuleBuffer);
							let auxInstance = new WebAssembly.Instance(auxModule, {
								"env": {
									...wasmResult.instance.exports
								}
							});

							return true;
						} catch (e) {
							console.error(e);
							return false;
						}
					},
					"grow_function_table": (numSlots) => {
						console.log("growing function table by ", numSlots);
						let mainTable = wasmResult.instance.exports["__indirect_function_table"];
						try {
							let latest_index = mainTable.grow(numSlots);
							return latest_index;
						} catch (e) {
							console.error(e);
							return -1;
						}
					},
				}
			}
			wasmResult = await WebAssembly.instantiateStreaming(fetch(`models/${modelName}/run.wasm`), importObject);
			return wasmResult;
		}

		var globalWasm = null;

		async function load() {
			console.log("loading");
			let name = document.getElementById('model_name').value;
			globalWasm = await instantiateMain(name);
			console.log("loaded; the module is available at `var globalWasm`");
		}

		function get_mem(addr, length = 4) {
			return new Uint8Array(globalWasm.instance.exports.memory.buffer, addr, length);
		}

		function list_globals() {
			console.log("Listing globals:");
			for (let key in globalWasm.instance.exports) {
				let expt = globalWasm.instance.exports[key];
				if (expt instanceof WebAssembly.Global) {
					let addr = expt.value;
					let value = null;
					let valueStr = null;
					try {
						value = get_mem(addr);
						valueStr = Array.from(value).map(b => b.toString(16).padStart(2, '0')).join(' ');
					} catch (e) {
						console.error(e);
					}
					console.log(`${key}: addr=${addr}, value=${valueStr || value}`);
				}
			}
		}

		function run_main() {
			console.log("running main()");
			globalWasm.instance.exports.main();
		}

		document.addEventListener('DOMContentLoaded', function () {
			document.getElementById('load').addEventListener('click', load);
			document.getElementById('run_main').addEventListener('click', run_main);
		});
	</script>
</body>

</html>